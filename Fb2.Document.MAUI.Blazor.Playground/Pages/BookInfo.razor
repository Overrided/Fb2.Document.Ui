@using Fb2.Document.Constants;
@using Fb2.Document.Html;
@using Fb2.Document.MAUI.Blazor.Playground.Data;
@using Fb2.Document.MAUI.Blazor.Playground.Services;
@using Fb2.Document.Models;
@using Fb2.Document.Models.Base;
@using System.Text;
@using Fb2.Document.MAUI.Blazor.Playground.Components;

@inject NavigationManager NavManager
@inject AppStateService AppStateService

@page "/bookInfo"

<style>
    .infoCol {
        overflow-y: auto;
    }

    .btn[aria-expanded=false] .infoExpanded {
        display: none;
    }

    .btn[aria-expanded=true] .infoCollapsed {
        display: none;
    }

    .btn:focus {
        outline: none !important;
    }

        .btn:focus:not(:focus-visible) {
            outline: 0;
            box-shadow: none;
        }

    .readBookBtn {
        border-radius: 90px;
        height: 60px;
        width: 60px;
        position: fixed;
        bottom: 20px;
        right: 20px;
    }

    .bookImagePreview {
        object-fit: contain;
        max-height: 200px;
        max-width: 190px;
        width: 190px;
    }

    .bookModalImagePreview {
        object-fit: contain;
        max-width: 190px;
        width: auto;
    }

    .modalContentWidth {
        width: 50vw;
    }

    .classRed {
        border: 2px solid red;
    }

    .classBlue {
        border: 2px solid blue;
    }

</style>

@if (SelectedBook != null)
{
    <div class="row h-100 m-0 g-0">

        <!--coverpage-->
        <div class="col-md-6 d-flex h-100 flex-nowrap p-2">
            <img class="align-self-center mx-auto my-auto d-block mh-100 mw-100" src="@SelectedBook.CoverpageBase64Image" />
        </div>

        <div class="infoCol col-md-6 px-2 pb-5 h-100">
            @if (TitleInfo != null)
            {
                <div class="card-body">
                    <TitleInfoBaseRenderer TitleInfo="TitleInfo" />
                </div>
            }

            @if (SrcTitleInfo != null)
            {
                <div class="card my-2">
                    <div class="card-header shadow-none" style="padding-left: 0 !important; outline: none !important;">
                        <button class="btn float-start"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#srcTitleInfoCollapse"
                                aria-expanded="false"
                                aria-controls="srcTitleInfoCollapse">

                            <span class="infoExpanded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>
                            <span class="infoCollapsed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>

                            <span>Source Title Info</span>
                        </button>
                    </div>

                    <div class="card-body collapse" id="srcTitleInfoCollapse">
                        <TitleInfoBaseRenderer TitleInfo="SrcTitleInfo" />
                    </div>
                </div>
            }

            @if (BookImages != null && BookImages.Count > 0)
            {
                <ModalWindow @ref="modalRef" ContentClass="modalContentWidth">
                    <Content>
                        @if (SelectedBookImage != null)
                        {
                            <div style="height: 91.5vh" class="row">
                                <div class="row flex-row flex-nowrap px-3 py-2 m-0 @(BookImages.Count > 1 ? "h-75" : "h-100")">
                                    <img class="align-self-center mx-auto my-auto d-block mh-100 mw-100 w-auto"
                                         src="@SelectedBookImage.ImageSource"
                                         title="@SelectedBookImage.ImageId" />

                                    <button @onclick="() => CloseImageModal()"
                                            type="button"
                                            class="btn close position-absolute w-auto"
                                            style="right:0;top:0">
                                        &times;
                                    </button>
                                </div>
                                @if (BookImages.Count > 1)
                                {
                                    <div class="row flex-row flex-nowrap m-0 h-25 bg-opacity-10 bg-secondary py-1" style="overflow-x:auto">
                                        @foreach (var image in BookImages)
                                        {
                                            <img src="@image.ImageSource"
                                                 class="@(image == SelectedBookImage ? "bg-info" : "bg-transparent") bookModalImagePreview mx-1"
                                                 title="@image.ImageId" @onclick="() => OnModalPreviewImageClick(image)" />
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </Content>
                </ModalWindow>

                <div class="card my-2">
                    <div class="card-header shadow-none" style="padding-left: 0 !important; outline: none !important;">
                        <button class="btn float-start"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#bookImagesCollapse"
                                aria-expanded="false"
                                aria-controls="bookImagesCollapse">

                            <span class="infoExpanded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>
                            <span class="infoCollapsed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>

                            <span>Images (@(BookImages.Count))</span>
                        </button>
                    </div>

                    <div class="card-body collapse p-0" id="bookImagesCollapse">
                        <div class="row flex-row flex-nowrap p-3 m-0" style="overflow-x:auto">
                            @foreach (var image in BookImages)
                            {
                                <img src="@image.ImageSource" class="bookImagePreview" @onclick="() => OnImageClick(image)" />
                            }
                        </div>
                    </div>
                </div>
            }

            @if (PublishInfo != null)
            {
                <div class="card my-2">
                    <div class="card-header shadow-none" style="padding-left: 0 !important; outline: none !important;">
                        <button class="btn float-start"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#publishInfoCollapse"
                                aria-expanded="false"
                                aria-controls="publishInfoCollapse">

                            <span class="infoExpanded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>
                            <span class="infoCollapsed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>

                            <span>Publish Info</span>
                        </button>

                    </div>

                    <div class="card-body collapse" id="publishInfoCollapse">
                        <PublishInfoRenderer PublishInfo="PublishInfo" />
                    </div>
                </div>
            }

            @if (DocumentInfo != null)
            {
                <div class="card my-2">
                    <div class="card-header shadow-none" style="padding-left: 0 !important; outline: none !important;">
                        <button class="btn float-start"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#documentInfoCollapse"
                                aria-expanded="false"
                                aria-controls="documentInfoCollapse">

                            <span class="infoExpanded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>
                            <span class="infoCollapsed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>

                            <span>Document Info</span>
                        </button>
                    </div>

                    <div class="card-body collapse" id="documentInfoCollapse">
                        <DocumentInfoRenderer DocumentInfo="DocumentInfo" />
                    </div>
                </div>
            }

            @if (CustomInfo != null)
            {
                <div class="card my-2">
                    <div class="card-header shadow-none" style="padding-left: 0 !important; outline: none !important;">
                        <button class="btn float-start"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#customInfoCollapse"
                                aria-expanded="false"
                                aria-controls="customInfoCollapse">

                            <span class="infoExpanded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>
                            <span class="infoCollapsed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>

                            <span>Custom Info</span>
                        </button>
                    </div>

                    <div class="card-body collapse" id="customInfoCollapse">
                        <CustomInfoRenderer CustomInfo="CustomInfo" />
                    </div>
                </div>
            }

            @if (FileInfo != null)
            {
                <div class="card my-2">
                    <div class="card-header shadow-none" style="padding-left: 0 !important; outline: none !important;">
                        <button class="btn float-start"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#fileInfoCollapse"
                                aria-expanded="false"
                                aria-controls="fileInfoCollapse">

                            <span class="infoExpanded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>
                            <span class="infoCollapsed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </span>

                            <span>File Info</span>
                        </button>
                    </div>

                    <div class="card-body collapse" id="fileInfoCollapse">
                        <FileInfoRenderer FileInfo="FileInfo" />
                    </div>
                </div>
            }

            <button class="readBookBtn btn btn-primary p-3" @onclick="ReadBook">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-book" viewBox="0 0 16 16">
                    <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z" />
                </svg>
            </button>

        </div>
    </div>
}

@code {
    public class FileInfoViewModel
    {
        public string FilePath { get; set; } = string.Empty;
        public string FileName { get; set; } = string.Empty;
        public long FileSizeInBytes { get; set; } = 0;

        public override bool Equals(object? obj)
        {
            return obj is FileInfoViewModel model &&
                   FilePath == model.FilePath &&
                   FileName == model.FileName &&
                   FileSizeInBytes == model.FileSizeInBytes;
        }

        public override int GetHashCode()
        {
            return HashCode.Combine(FilePath, FileName, FileSizeInBytes);
        }
    }

    public class BookImageViewModel
    {
        public string ImageSource { get; set; } = string.Empty;
        public string ImageId { get; set; } = string.Empty;

        public override bool Equals(object? obj)
        {
            return obj is BookImageViewModel model &&
                   ImageSource == model.ImageSource &&
                   ImageId == model.ImageId;
        }

        public override int GetHashCode()
        {
            return HashCode.Combine(ImageSource, ImageId);
        }
    }

    private ModalWindow modalRef = new();

    private BookModel? SelectedBook = null;

    private TitleInfoBase? TitleInfo = null;
    private TitleInfoBase? SrcTitleInfo = null;
    private List<BookImageViewModel>? BookImages = null;
    private PublishInfo? PublishInfo = null;
    private DocumentInfo? DocumentInfo = null;
    private CustomInfo? CustomInfo = null;
    private FileInfoViewModel? FileInfo = null;

    private BookImageViewModel? SelectedBookImage = null;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        SelectedBook = AppStateService.CurrentBookModel;

        if (SelectedBook == null)
            return;

        var doc = SelectedBook.Fb2Document;

        TitleInfo = doc.Title;
        SrcTitleInfo = doc.SourceTitle;
        BookImages = doc.BinaryImages.Select(bi =>
        {
            var contentType = bi.TryGetAttribute(AttributeNames.ContentType, out var contentTypeAttr) ?
                            contentTypeAttr!.Value : string.Empty;

            var bookImageSource = $"data:{contentType};base64,{bi.Content}";
            var bookImageId = bi.TryGetAttribute(AttributeNames.Id, out var idAttr) ?
                            idAttr!.Value : string.Empty;
            return new BookImageViewModel
                {
                    ImageId = bookImageId,
                    ImageSource = bookImageSource
                };
        })?.ToList();
        PublishInfo = doc.PublishInfo;
        DocumentInfo = doc.DocumentInfo;
        CustomInfo = doc.CustomInfo;
        FileInfo = new FileInfoViewModel
            {
                FileName = SelectedBook.FileName,
                FilePath = SelectedBook.FilePath,
                FileSizeInBytes = SelectedBook.FileSizeInBytes
            };
    }

    public void OnImageClick(BookImageViewModel selectedImage)
    {
        this.SelectedBookImage = selectedImage;
        modalRef.Open();
    }

    public void OnModalPreviewImageClick(BookImageViewModel selectedImage)
    {
        this.SelectedBookImage = selectedImage;
    }

    public void CloseImageModal()
    {
        modalRef.Close();
    }

    public void ReadBook()
    {
        NavManager.NavigateTo("/readBook", false, false);
    }
}
